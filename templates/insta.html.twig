{# -----------------------------------------------------------------------------
   File: templates/insta.html.twig
   Version: MEILI-INSTA v4.9
   Notes:
   - Keyword mode: facets sidebar + hits (original layout).
   - Embedder mode: NO facets UI, but a hidden refinementList target so Stimulus is happy.
#}
{% extends "@SurvosMeili/base.html.twig" %}

{% block title %}{{ indexName }} InstaSearch{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    .insta-grid {
      gap: 0;
    }

    /*
    .insta-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .insta-grid { grid-template-columns: 1fr; }
    }
    */
    .facet-header { display: flex; align-items: baseline; gap: .75rem; }
    .facet-title { text-transform: none; font-weight: 600; }
    .facet-actions { margin-left: auto; display: inline-flex; gap: .35rem; }
  </style>

  <style>
    body {
      background: #C4E0E5 !important;
    }
    .insta-grid [class^='ais-'] {
      box-sizing: border-box;
    }
    .insta-grid .facet-block {
      background: rgba(255, 255, 255, 0.5);
      border: none;
      box-shadow: none;
      margin-bottom: 1rem !important;
    }
    .insta-grid .facet-title {
      color: #000000;
      font-size: 1.25rem;
      font-weight: 900;
    }
    .insta-grid .facet-collapse {
      background-color: rgba(0, 0, 0, 0.05);
      border: none;
      border-radius: 50%;
      box-shadow: none;
      min-height: 2rem;
      min-width: 2rem;
    }
    .insta-grid .facet-collapse:hover {
      background-color: rgba(0, 0, 0, 0.0625);
    }
    .insta-grid .facet-collapse:active {
      background-color: rgba(0, 0, 0, 0.075) !important;
      color: inherit !important;
    }
    .insta-grid .facet-body {
      margin-top: 1rem !important;
    }

    .insta-grid .ais-RefinementList-item {
      padding: 0.25rem 0;
    }
    .insta-grid .ais-RefinementList-checkbox {
      background: rgba(255, 255, 255, 0.75);
      border: none;
      cursor: pointer;
      height: 1.5rem;
      width: 1.5rem;
    }
    .insta-grid .ais-RefinementList-checkbox:checked {
      background: rgba(255, 255, 255, 0.75);
      border-color: transparent;
    }
    .insta-grid .ais-RefinementList-checkbox:checked::after {
      background: transparent;
      border-radius: inherit;
      color: #000000;
      content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='m9.55 18l-5.7-5.7l1.425-1.425L9.55 15.15l9.175-9.175L20.15 7.4z'/%3E%3C/svg%3E");
      display: inline-grid;
      height: 1.5rem;
      line-height: 1;
      place-content: center;
      width: 1.5rem;
    }
    .insta-grid .ais-RefinementList-count {
      background: rgba(255, 255, 255, 0.5);
      border-radius: 999px;
      color: #000000;
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }
    .insta-grid .ais-RefinementList-showMore {
      background: rgba(0, 150, 219, 0.5);
      font-size: 0.875rem;
      font-weight: 500;
      margin-top: 1rem;
      padding: 0.625rem 0.75rem;
      width: 100%;
    }
    .insta-grid .ais-RefinementList-showMore:hover {
      background: rgba(0, 150, 219, 0.625);
    }
    .insta-grid .ais-RefinementList-showMore:focus {
      background: rgba(0, 150, 219, 0.625);
    }
    .insta-grid .ais-Pagination {
      margin-bottom: 1.5rem;
    }
    .insta-grid .ais-Pagination-link {
      align-items: center;
      background: rgba(255, 255, 255, 0.875);
      border: none;
      border-radius: 50%;
      display: inline-flex;
      font-size: 0.875rem;
      font-weight: 600;
      height: 2.25rem;
      justify-content: center;
      min-width: 2.25rem;
    }
    .insta-grid .ais-Pagination-link:hover {
      text-decoration: none;
    }
    .insta-grid .ais-Pagination-item--selected .ais-Pagination-link {
      background-color: rgba(0, 150, 219, 0.5);
      border-color: transparent;
    }
    .insta-grid .ais-InfiniteHits {
      margin-top: 1rem;
    }
    .insta-grid .ais-InfiniteHits .ais-InfiniteHits-list {
      display: grid !important;
      grid-template-columns: repeat(var(--cols), 1fr);
      gap: 1rem;
      margin: 0;
    }
    @media (max-width: 767px) {
      .insta-grid .ais-InfiniteHits .ais-InfiniteHits-list {
        --cols: 2 !important;
      }
    }
    .insta-grid .ais-InfiniteHits-list .ais-InfiniteHits-item {
      border: none;
      box-shadow: none;
      margin: 0;
      padding: 0;
      width: 100% !important;
    }
    .insta-grid .ais-InfiniteHits-list .ais-InfiniteHits-item .insta-hit {
      height: 100%;
    }
    .insta-grid .ais-InfiniteHits-list .ais-InfiniteHits-item .card {
      background: rgba(255, 255, 255, 0.5);
      box-shadow: none !important;
    }
    .insta-grid .ais-InfiniteHits-list .ais-InfiniteHits-item .card-body > img {
      border-radius: 0.375rem;
      filter: drop-shadow(0 0.25rem 0.5rem rgba(0, 0, 0, 0.375));
      min-height: 160px !important;
    }
    .insta-grid .ais-InfiniteHits-list .ais-InfiniteHits-item .card-title {
      font-size: 0.875rem;
      font-weight: 600;
      line-height: 1.125rem;
      margin-top: 0.75rem;
      text-align: center;
    }
    .insta-grid .ais-InfiniteHits-loadMore {
      background: rgba(0, 150, 219, 0.5);
      border: none;
      box-shadow: none;
      display: block;
      margin: 2rem auto;
    }
    .insta-grid .ais-InfiniteHits-loadMore:hover {
      background: rgba(0, 150, 219, 0.625);
    }
    .insta-grid .ais-InfiniteHits-loadMore:focus {
      background: rgba(0, 150, 219, 0.625);
    }
    .insta-grid .ais-InfiniteHits-loadMore:active {
      background: rgba(0, 150, 219, 0.75) !important;
    }
    /*
    @media (min-width: 768px) {
      .insta-grid .ais-InfiniteHits-loadMore {
        display: none;
      }
    }
    */
    @media (min-width: 900px) {
      .insta-grid > aside {
        align-self: start;
        height: calc(100vh - 1rem);
        overflow-y: auto;
        position: sticky;
        top: 1rem;
      }
    }
    .insta-grid .ais-SearchBox {
      height: 3rem;
    }
    .insta-grid .ais-SearchBox-form {
      background: rgba(255, 255, 255, 0.5);
      border: none;
      border-radius: 999px;
      height: 3rem;
    }
    .insta-grid > main .ais-SearchBox-input {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 1rem;
      font-weight: 500;
      height: 100%;
      padding: 0.25rem 1rem;
    }
    .insta-grid .ais-SearchBox-submit {
      background: rgba(0, 150, 219, 0.5);
      border: none;
      height: 3rem;
      margin-left: auto;
      min-width: 3rem;
      right: 0;
      top: 0;
      transform: none;
    }
    .insta-grid .ais-SearchBox-resetIcon {
      left: -40px;
    }
    .insta-grid .ais-ClearRefinements-button {
      background: transparent;
      border: none;
      color: rgba(0, 150, 219, 0.75);
      font-size: 0.75rem;
      font-weight: 500;
      height: 3rem;
      padding: 0rem 0.5rem !important;
      text-transform: uppercase;
    }
    .insta-grid .ais-ClearRefinements-button:hover {
      background: transparent;
      color: rgba(0, 150, 219, 1);
      text-decoration: none;
    }
    .insta-grid .ais-ClearRefinements-button:focus {
      background: transparent;
      color: rgba(0, 150, 219, 1);
    }
    .insta-grid .ais-ClearRefinements-button:active {
      background: transparent;
      border: none;
      color: rgba(0, 150, 219, 1);
    }
    .insta-grid .ais-RangeSlider .rheostat-handle {
      margin-left: 0;
    }
    .insta-grid .rheostat-tooltip {
      margin-left: 0;
      top: -28px;
    }
    .insta-grid .rheostat-progress {
      background: rgba(0, 150, 219, 0.5);
    }
    .insta-grid input, .insta-grid textarea {
      background: rgba(255, 255, 255, 0.5);
    }
    .insta-grid .ais-RefinementList-labelText {
      font-size: 0.875rem;
    }
    .insta-grid mark.ais-Highlight, .insta-grid em.ais-Highlight {
      background: linear-gradient(45deg, #BBDB47, #CEE57A, #D4E88B);
      border-radius: 0;
      color: #000000;
      font-weight: 300;
      line-height: 1;
      padding: 0.0625rem 0.125rem !important;
      vertical-align: text-bottom;
    }
    .insta-grid .card-footer {
      word-break: break-word;
    }

    .meili-header {
      align-items: center;
      backdrop-filter: blur(4px);
      background: rgba(255, 255, 255, 0.75);
      display: flex;
      justify-content: space-between;
      position: sticky;
      top: 0;
      width: 100%;
      z-index: 50;
    }
    .meili-header .meili-bar {
      align-items: center;
      background: transparent;
      border-bottom: none;
      gap: 1.5rem;
      min-height: 3rem;
      overflow-x: auto;
      padding: 0.75rem 1.5rem;
    }
    .meili-header > .dropdown {
      margin-right: 16px;
    }
    .meili-chip {
      align-items: center;
      background: rgba(0, 0, 0, 0.075);
      border-radius: 999px;
      color: inherit;
      display: inline-flex;
      flex-shrink: 0;
      font-size: 0.75rem;
      line-height: 1;
      padding: 0.25rem 0.625rem;
    }
    .meili-bar-left {
      align-items: center;
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
    }
    .meili-bar-right {
      align-items: center;
      display: flex;
      gap: 0.5rem;
    }
    .meili-bar > li {
      list-style: none;
    }
    .meili-bar > a, .meili-bar > li > a {
      align-items: center;
      color: inherit;
      display: flex;
      font-size: 0.875rem;
      font-weight: 500;
      gap: 0.5rem;
      text-decoration: none;
    }
    .meili-bar > a:hover, .meili-bar li a:hover {
      color: rgba(0, 150, 219, 0.75);
      text-decoration: none;
    }
    .meili-bar svg {
      height: 1rem;
      width: 1rem;
    }

    :root {
      --canvas-color: #C4E0E5;
      --canvas-color-rgb: 196, 224, 229;
    }
    .btn.btn-show-facets-sidebar {
      bottom: 2rem;
      left: 50%;
      position: sticky;
      transform: translateX(-50%);
      width: max-content;
    }
    .btn.btn-show-facets-sidebar svg {
      height: 1.25rem;
      margin-right: 0.25rem;
      width: 1.25rem;
    }

    /* Facets Sidebar */
    #facets-sidebar {
      background-color: var(--canvas-color);
    }
    #facets-sidebar .offcanvas-body {
      scrollbar-width: none;
    }
    #facets-sidebar .offcanvas-title {
      font-size: 1.5rem;
      font-weight: 900;
    }



    .insta-grid .ais-InfiniteHits-item .card-body .blockquote {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      overflow: hidden;
      word-break: break-word;
      font-size: 0.875rem !important;
    }

    .insta-grid .ais-InfiniteHits-item .card-body .badge.bg-secondary {
      background-color: rgba(0, 0, 0, 0.075) !important;
      color: #000000;
      font-size: 0.8125rem;
    }

    .insta-grid .ais-InfiniteHits-item .card-body .card-body.p-3 {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      overflow: hidden;
      word-break: break-word;
      font-size: 0.875rem !important;
      padding: 0 !important;
      margin: 1rem 0;
    }

    .insta-grid .semantic-toolbar {

    }

    .ais-RefinementList-showMore:disabled {
      display: none;
    }


  </style>
{% endblock %}

{% block body %}
    {% set debug = app.request.query.get('debug', false) %}

  {# === Keep these blocks intact (critical for controllers/templates) === #}
  {% set globals = {
    serverUrl: server,
    serverApiKey: apiKey,
    indexName: indexName,
    _sc_modal: '@survos/meili-bundle/json',
    debug: debug
  } %}

  {% set icons = {
    json: ux_icon('si:json-duotone'),
    bug: ux_icon('tabler:bug'),
    wikidata: ux_icon('openmoji:wikidata'),
    website: ux_icon('fluent-mdl2:website'),
    facebook: ux_icon('mdi:facebook'),
  } %}

  {# Columns priority: indexConfig.ui.columns -> request ?cols= -> 3 #}
  {% set cols =
    (indexConfig.ui.columns is defined and indexConfig.ui.columns ? indexConfig.ui.columns
      : (app.request.query.get('cols') ?? 3)
    )
  %}

  {% set _sc = '@survos/meili-bundle/insta' %}
  {% set _sc_modal = '@survos/meili-bundle/json' %}
  {% set templateUrl = path('meili_template', { templateName: templateName }) %}

  {# set default to false during production or when this is completely debugged #}
  {% set sanity = app.request.query.get('sanity', true) %}
    {% set grid = app.request.query.get('class', 'grid-' ~ app.request.query.get('grid')|default(2)) %}

  <div
    {{ stimulus_controller(_sc, {
      serverUrl: server,
      serverApiKey: apiKey,
      indexName: indexName,
      sanity: sanity,

      embedderName: embedder,
      hitClass: 'grid-' ~ grid,

      sortingJson: sorting|default([])|json_encode,
      globalsJson: globals|json_encode,
      iconsJson: icons|json_encode,
      configJson: indexConfig|json_encode,

      templateUrl: templateUrl,
      q: q,
      searchAsYouType: searchAsYouType ? true : false,
      scoreThreshold: app.request.query.get('minScore')|default(0)
    })
    }}
    class="container-fluid py-3">

    <div class="insta-grid row" {{ stimulus_controller(_sc_modal, { serverUrl: server, serverApiKey: apiKey, indexName: indexName, globalsJson: globals|json_encode }) }}>
      {{ include('@SurvosMeili/components/_modal.html.twig', { _sc_modal: _sc_modal }) }}

      {# ------------------------------------------------------------------
         EMBEDDER / HYBRID MODE: no visible sidebar, but keep a hidden
         refinementList target so the controller doesn't throw.
         ------------------------------------------------------------------ #}
      {% if embedder|default(false) %}

        {# hidden dummy target to satisfy Stimulus "refinementList" requirement #}
        <div style="display:none" {{ stimulus_target(_sc, 'refinementList') }}></div>

        <main class="col-12">
          <div class="semantic-toolbar d-flex align-items-center gap-4 mb-3 overflow-x-auto p-3 rounded-3" style="background-color: rgba(255, 255, 255, 0.5);">
            <div class="row">
              <div class="col-auto me-2">
                <span>Semantic search:</span>
              </div>
              <div class="col-auto">
                <div class="row g-3 align-items-center">
                  <div class="col-auto">
                    <label for="semantic-range">Weight</label>
                  </div>
                  <div class="col-auto" style="display: grid; justify-items: center;">
                    {% set initialSemantic = (app.request.get('semantic') ?? 30) %}
                    <input
                      {{ stimulus_action(_sc, 'semantic', 'change') }}
                      {{ stimulus_target(_sc, 'semanticSlider') }}
                      id="semantic-range"
                      type="range" min="0" max="100" step="1"
                      value="{{ initialSemantic }}"
                      style="width: 180px;">
                  </div>
                  <div class="col-auto">
                    <output {{ stimulus_target(_sc, 'semanticOutput') }} class="text-muted">{{ initialSemantic }}%</output>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-auto">
              <div class="row g-3 align-items-center">
                <div class="col-auto">
                  <label for="min-score-mult">Min score ×0.01</label>
                </div>
                <div class="col-auto">
                  <input
                    id="min-score-mult"
                    type="number" min="0" max="100" step="1"
                    value="{{ (app.request.query.get('minScore', 0) * 100)|round(0, 'floor') }}"
                    class="form-control form-control-sm bg-white"
                    style="width: 110px;"
                    {{ stimulus_target(_sc, 'scoreMultiplier') }}
                    {{ stimulus_action(_sc, 'setMinScoreMultiplier', 'input') }}
                    {{ stimulus_action(_sc, 'setMinScoreMultiplier', 'change') }}>

                  <input type="hidden"
                    {{ stimulus_target(_sc, 'scoreThreshold') }}
                    value="{{ app.request.query.get('minScore', 0) }}">
                </div>
              </div>
            </div>
          </div>

          {# Search row: input + manual Search button (above results) #}
          <div class="mb-3 d-flex gap-2 align-items-center">
            <div class="flex-grow-1" {{ stimulus_target(_sc, 'searchBox') }}></div>

            <!--
            <button type="button"
                    class="btn btn-primary"
                    title="Run search (Enter ↵)"
                    {{ stimulus_target(_sc, 'submit') }}
                    {{ stimulus_action(_sc, 'submit', 'click') }}
                    style="{{ searchAsYouType ? 'display:none' : '' }}">
              Search ↵
            </button>
            -->

            <div {{ stimulus_target(_sc, 'reset') }}></div>
          </div>

          <div class="mb-2 small text-muted" {{ stimulus_target(_sc, 'stats') }}></div>
          <div class="mb-2" {{ stimulus_target(_sc, 'notice') }}></div>

          {# Hits list; pass columns via CSS custom property #}
          <div
            {{ stimulus_target(_sc, 'hits') }}
            style="--cols: {{ cols|e('html_attr') }};">
          </div>

          <div class="mt-4 d-none" {{ stimulus_target(_sc, 'pagination') }}></div>

          {% if globals.debug %}
          <div class="mb-3">
            <label class="form-label small text-muted">Outgoing   /multi-search payload</label>
            <textarea {{ stimulus_target(_sc, 'debug') }} class="form-control" rows="8" spellcheck="false"></textarea>
          </div>
          {% endif %}
        </main>

      {# ------------------------------------------------------------------
         KEYWORD MODE (no embedder): full grid with facets sidebar
         ------------------------------------------------------------------ #}
      {% else %}
          {# ---------- Facets (sidebar) ---------- #}
          <aside id="facets-sidebar" class="col-3 col-md-4 col-lg-3 offcanvas-md offcanvas-start border-info-subtle" aria-label="Filters" tabindex="-1" {{ stimulus_target(_sc, 'refinementList facetsSidebar') }}>
            <div class="offcanvas-header p-3 p-md-0 border-info-subtle">
              <h5 class="offcanvas-title">Filters</h5>
              <button type="button" class="btn-close" {{ stimulus_action(_sc, 'hideFacetsSidebar', 'click') }}></button>
            </div>
            <div class="offcanvas-body p-3 p-md-0">
              <div class="w-100">
                {% for name, conf in indexConfig.facets %}
                {% set widget = conf.widget ?? conf.type ?? 'RefinementList' %}
                <div class="facet-block mb-3" data-facet-block>
                  <div class="facet-header">
                      {% set fieldDescription = false %}
                      {% if translationStyle == 'simple' %}
                      {% set label = (name ~ '.label')|trans(domain: indexConfig.rawName) %}
                      {% set fieldDescription = (name ~ '.description')|trans(domain: indexConfig.rawName) %}
                      {% elseif translationStyle == 'compound' %}
                      {% set label = (name ~ '.label')|trans(domain: indexConfig.rawName) %}
                      {% set fieldDescription = (name ~ '.description')|trans(domain: indexConfig.rawName) %}
                          {% else %}
                              {% set label = name %}
                              {% endif %}
                    <h3 class="facet-title h6 m-0" {% if fieldDescription %}title="{{ fieldDescription }} {% endif %}">{{ label }}</h3>
                    <span class="facet-actions">
                      <button class="facet-collapse btn btn-ghost btn-xxs p-0"
                              type="button"
                              data-collapse-control
                              data-attribute="{{ name }}"
                              aria-expanded="{{ (conf.collapsed is same as(true)) ? 'false' : 'true' }}"
                              title="Collapse/Expand">
                        {{ ux_icon('tabler:chevron-down')|raw }}
                      </button>
                    </span>
                  </div>
                  <div class="facet-body mt-2">
                    <div
                      data-attribute="{{ name }}"
                      data-search-mode="{{ conf.searchMode|default('contains') }}"
                      data-widget="{{ widget }}"
                      {% if conf.sortMode is defined %} data-sort-mode="{{ conf.sortMode }}"{% endif %}
                      {% if conf.searchable is same as(true) %} data-searchable="true"{% elseif conf.searchable is same as(false) %} data-searchable="false"{% endif %}
                      {% if conf.limit is defined %} data-limit="{{ conf.limit }}"{% endif %}
                      {% if conf.showMoreLimit is defined %} data-show-more-limit="{{ conf.showMoreLimit }}"{% endif %}
                      {% if conf.lookup is defined and conf.lookup is iterable %} data-lookup='{{ conf.lookup|json_encode }}'{% endif %}
                      {% if widget == 'RangeSlider' %}
                        {% if conf.step is defined %} data-step="{{ conf.step }}"{% endif %}
                        {% if conf.min is defined %} data-min="{{ conf.min }}"{% endif %}
                        {% if conf.max is defined %} data-max="{{ conf.max }}"{% endif %}
                        {% if conf.pips is defined %} data-pips="{{ conf.pips ? 'true' : 'false' }}"{% endif %}
                        {% if conf.tooltips is defined %} data-tooltips='{{ conf.tooltips|json_encode }}'{% endif %}
                      {% endif %}>
                    </div>
                  </div>
                </div>
              {% endfor %}
              </div>
            </div>
          </aside>

          {# ---------- Main (search, hits) ---------- #}
          <main class="col-12 col-md-8 col-lg-9">

            <div class="semantic-toolbar d-flex align-items-center gap-2 mb-3 overflow-x-auto justify-content-end">
              <div class="row g-3 align-items-center">
                <div class="col-auto">
                  <label class="col-form-label">Sort By</label>
                </div>
                <div class="col-auto">
                  <div {{ stimulus_target(_sc, 'sortBy') }}></div>
                </div>
              </div>
            </div>

            <div class="mb-3 d-flex gap-2 align-items-center">
              <div class="flex-grow-1" {{ stimulus_target(_sc, 'searchBox') }}></div>

              <button type="button"
                      class="btn btn-primary"
                      title="Run search (Enter ↵)"
                      {{ stimulus_target(_sc, 'submit') }}
                      {{ stimulus_action(_sc, 'submit', 'click') }}
                      style="{{ searchAsYouType ? 'display:none' : '' }}">
                Search ↵
              </button>

              <div {{ stimulus_target(_sc, 'reset') }}></div>
            </div>

            <div class="mb-2 small text-muted" {{ stimulus_target(_sc, 'stats') }}></div>
            <div class="mb-2" {{ stimulus_target(_sc, 'notice') }}></div>

            <div
              {{ stimulus_target(_sc, 'hits') }}
              style="--cols: {{ cols|e('html_attr') }};">
            </div>

            <div class="mt-4 d-none" {{ stimulus_target(_sc, 'pagination') }}></div>

            <div class="mb-3">
              <label class="form-label small text-muted">Outgoing /multi-search payload</label>
              <textarea {{ stimulus_target(_sc, 'debug') }} class="form-control" rows="8" spellcheck="false"></textarea>
            </div>
          </main>
      {% endif %}
    </div>

    {% if embedder|default(false) %}

    {% else %}
    <button class="btn btn-dark d-md-none btn-show-facets-sidebar" {{ stimulus_action(_sc, 'showFacetsSidebar', 'click') }}>
      {{ ux_icon('heroicons:adjustments-horizontal') }}
      Show Filters
    </button>
    {% endif %}
  </div>
{% endblock %}
